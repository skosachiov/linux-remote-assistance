- name: Create no-shell user
  block:
    - name: Create no-shell user Useradd
      user:
        name: no-shell
        shell: /bin/false
        append: yes
        generate_ssh_key: yes
    - name: Create no-shell user Add cert to authorized keys
      authorized_key:
        user: no-shell
        state: present
        key: /home/no-user/.ssh/id_rsa.pub
  tags:
    - server
    - create_no_shell_user

- name: Ensure openssh-server is installed
  block:
    - name: Ensure openssh-server is installed Package
      package:
        name: openssh-server
        state: present
    - name: Ensure openssh-server is installed Started
      service:
        name: openssh-server
        state: started
  tags:
    - server
    - openssh_server_is_started

- name: Install client dependencies
  package:
    name:
      - x11vnc
      - tigervnc
      - zenity
    state: present
  tags:
    - client
    - install_client_dependencies

[Desktop Entry]
Type=Application
Name=Remote Assistance Full control

Exec=

/bin/bash -c '
pass=$((32767+$RANDOM));
port=$((32767+$RANDOM));
disp=$(echo $DISPLAY|grep -o ":[0-9]*");
(x11vnc -bg {{viewonly}} -passwd $pass -rfbport $port -display $disp > /dev/null 2>&1);
(/usr/bin/ssh -N -i /usr/local/etc/id_rsa -R $port:localhost:$port no-shell@$SSHSERVER &);
sleep 1;
if [ "$(pidof ssh)" == "" ];
then zenity --info --text="<span font=\"16\">No connection</span>" --ok-label="Exit";
else zenity --info --text="<span font=\"16\">Connection has been established\nID=$port, PIN=$pass</span>" --ok-label="Disconnect";
fi;
killall x11vnc; killall ssh
'

Icon=audio-headset
StartupNotify=false

# TODO - server_rollback
# TODO - client_rollback
    
